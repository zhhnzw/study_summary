## 分布式锁

加锁操作：set lock:codehole true ex 5 nx

这个命令即setnx和expire组合在一起的原子命令，即分布式锁的奥义所在

基本解锁操作：del lock:codehole

### 锁
锁, 本质上是一种处理抢占资源的机制，避免多线程下造成对共享资源的更新不一致的问题

分布式锁, 本质还是一种锁，起这个名字是为了便于描述这种锁的特点，针对分布式应用，进行锁控制的锁，就叫分布式锁

### redis的分布式锁不能解决超时问题

#### 案例：

1. A在0秒设置一个有效期为2秒的锁。 
2. 2.B在3秒时申请会拿到锁（因为A设置的锁已经过期） 
3.  A在4秒时，做完事情，以为锁还在自己手上，就去删除锁。 B拿到的锁会被A删掉。 这时候如果有C申请锁，B和C就会同时持有锁

#### 解决以上问题的初步办法：

1. 分布式锁不要用在较长时间的任务，避免遇到超时问题

2. 另稍微安全一点的方案：为 set 指令的 value 参数设置为一个随机数，释放锁时先匹配随机数是否一致，然后再删除 key，这是为了确保当前线程占有的锁不会被其它线程释放，除非这个锁是过期了被服务器自动释放的

3. 升级版解锁操作：即以上方案的应用，执行lua脚本来解锁。判断随机数是否匹配，匹配再执行删除操作。利用redis支持的lua脚本来确保这个操作的原子性。